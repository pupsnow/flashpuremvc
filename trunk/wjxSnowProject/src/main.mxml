<?xml version="1.0" encoding="utf-8"?>
<mx:Application xmlns:mx="http://www.adobe.com/2006/mxml" 
	width="100%" height="100%"  layout="vertical"
	paddingBottom="0" paddingLeft="0" paddingRight="0" paddingTop="0"
	creationComplete="init()" xmlns:panel="org.flowDesign.panel.*" 
	xmlns:zoomer="org.flowDesign.zoomer.*"
	modalTransparency="0.2" modalTransparencyBlur="0.1">
	<mx:Script>
		<![CDATA[
			import mx.managers.PopUpManager;
			import org.flowDesign.panel.ShowDataWin;
			import mx.events.CloseEvent;
			import mx.charts.BubbleChart;
			import org.ImageSnop;
			import flash.utils.setTimeout;
			import flash.utils.setInterval;
			import mx.controls.Alert;
			import org.flowDesign.layout.LineTool;
			import org.flowDesign.layout.VBrokenLineTool;
		//拖运进入事件
		private var firstNodeNum:int=0;
		private var firstLineNum:int=0;
		private var isBaind:Boolean=false;
		
		/**点击工具事件*/
		private function selectTool(event:Event):void
		{
			var toolsEvent:Tools=event.currentTarget as Tools;
			switch(toolsEvent.selectTool)
			{
				case "node":fl.currentTool = null; break;
				case "line": fl.currentTool = org.flowDesign.layout.LineTool;break;
				case "vcurveLine":fl.currentTool = org.flowDesign.layout.VBrokenLineTool;break;
				case "hcurveLine":fl.currentTool = org.flowDesign.layout.HBrokenLineTool;break;
				case "move":fl.currentTool = null;break;
			}
			event.stopPropagation();
		}
		
		
		private function showxml():void
		{
			var xml:XML = fl.dataProvider;
			var re:ShowDataWin = new ShowDataWin();
				re.res ="<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n"+xml.toString();
			PopUpManager.addPopUp(re,this,true);
			PopUpManager.centerPopUp(re);
		}
		
		private function showNodeH():void
		{
//			Alert.show("弹出修改节点属性框,或则其他","提示");
		}
		
		private function showLineH():void
		{
//			Alert.show("弹出修改线属性框,或则其他","提示");
		}
		private var timer : Timer;
		private function init():void
		{
				timer = new Timer(500);
				timer.addEventListener( TimerEvent.TIMER, onTimerEvent );
				timer.start();
               var o:Object = new Object();
				o.source = fl;
                aa.data = o;
          }
		private function onTimerEvent( event : TimerEvent ) : void
		{
			Application.application.dispatchEvent( new Event("updateImage") );
		}
	      import mx.graphics.ImageSnapshot;
          import mx.graphics.codec.*;

          private const jpegEnc:JPEGEncoder = new JPEGEncoder();
			
		  private var fr:FileReference = new FileReference();
		  [Bindable]
		  private var isok:Boolean = true;
		  private function save(evt:MouseEvent):void {
                 var imageSnap:ImageSnop = ImageSnop.captureImage(fl,0, jpegEnc);
                fr.save(imageSnap.data, "describeType.jpg");
            }
            private function delay():void
            {
            	proidd.text = "正在处理图片。。。。";
            	var timer:Timer = new  Timer(500,1)
            		timer.addEventListener(TimerEvent.TIMER,timerH);
            		timer.start();
            }
            private var imageSnap:ImageSnop;
            private function timerH(e:TimerEvent):void
            {
            	 imageSnap = ImageSnop.captureImage(fl,0, jpegEnc);
            	 proidd.text = "";
            	 Alert.show("图片处理完毕","提示",4,this,closeH);;
            }
            private function closeH(e:CloseEvent):void
            {
            	 fr.save(imageSnap.data, "describeType.jpg");
            }
			
			
			private function mouseMove(e:MouseEvent):void
			{
				var x:Number = flowPrentVbox.contentMouseX+10;
				var y:Number = flowPrentVbox.contentMouseY+10;
				if(x+out.width>flowPrentVbox.x+flowPrentVbox.width)
				{
					x = x-out.width-20;
				}
				out.x = x;
				out.y = y;
			}
		]]>
	</mx:Script>
	<mx:Style>
		global
			{
				fontSize: 12;
			}
	</mx:Style>
	<mx:XML xmlns="" id="da">
<result>
  <node>
    <node id="node20090824152712" name="结束结点" nodeState="default" type="end" TypeId="2" x="273" y="71">
      <property>
        <property id="node_title" property="text" value="结束结点"/>
        <property id="remark" property="text" value=""/>
      </property>
    </node>
    <node id="node20090824152709" name="子流程" nodeState="default" type="child" TypeId="6" x="535" y="236">
      <property>
        <property id="node_title" property="text" value="子流程"/>
        <property id="remark" property="text" value=""/>
      </property>
    </node>
    <node id="node20090824152711" name="开始结点" nodeState="default" type="start" TypeId="1" x="73" y="159">
      <property>
        <property id="node_title" property="text" value="开始结点"/>
        <property id="remark" property="text" value=""/>
      </property>
    </node>
    <node id="node20090824152714" name="并行环节" nodeState="default" type="parallel_links" TypeId="5" x="270" y="315">
      <property>
        <property id="node_title" property="text" value="并行环节"/>
        <property id="remark" property="text" value=""/>
      </property>
    </node>
  </node>
  <line>
    <node id="node20090824152711node20090824152712" name="node20090824152711node20090824152712" fromNodeId="node20090824152711" toNodeId="node20090824152712" lineType="org.flowDesign.layout::LineTool" lineState="default">
      <property>
        <property id="line_title" property="text" value="1111111111111"/>
        <property id="line_remark" property="text" value="111111"/>
      </property>
    </node>
    <node id="node20090824152714node20090824152709" name="node20090824152714node20090824152709" fromNodeId="node20090824152714" toNodeId="node20090824152709" lineType="org.flowDesign.layout::LineTool" lineState="default">
      <property>
        <property id="line_title" property="text" value="44444"/>
        <property id="line_remark" property="text" value="4444444444"/>
      </property>
    </node>
    <node id="node20090824152711node20090824152714" name="node20090824152711node20090824152714" fromNodeId="node20090824152711" toNodeId="node20090824152714" lineType="org.flowDesign.layout::LineTool" lineState="default">
      <property>
        <property id="line_title" property="text" value="22222222"/>
        <property id="line_remark" property="text" value="2222222222"/>
      </property>
    </node>
  </line>
</result>
	</mx:XML>
		<panel:Tools  select="selectTool(event)"   
			id="tools"   width="100%"   horizontalAlign="center">
		</panel:Tools>			
		<mx:Canvas id="flowPrentVbox" width="100%" 
			    alpha="1.0" height="100%" borderStyle="inset">
				<panel:DragScrollingCanvas width="100%" height="100%" 
					childrenDoDrag="true">
					<panel:FlowDesignPanel   id="fl"  dataProvider="{da}"
						nodeProperty="showNodeH()" 
						lineProPerty="showLineH()" maxWidth="2880" maxHeight="2880"
						backgroundColor="0xffffff" width="2870" height="2290">
					</panel:FlowDesignPanel>
				</panel:DragScrollingCanvas>
				<zoomer:UIThumbMap  id="aa" width="200" height="200" mouseMove="mouseMove(event)"
					backgroundColor="#785C5C" right="16" top="0" backgroundAlpha="1"
					mouseOut="{out.visible =false}" mouseOver="{out.visible = true}"/>
				<zoomer:ZoomReticle target="{aa}" width="80" height="80" 
					 id="out"
					zoom="10" visible="true"
					eventType="roll-over" shape="rectangle"
					draggable="false" followMouse="false"
					backgroundColor="0xffffff" borderColor="0x000000"/>
		</mx:Canvas>
		<mx:HBox width="100%" height="20" backgroundColor="#C4DFFA" borderStyle="outset" 
			horizontalAlign="left" >
	        <mx:Button label="xml" click="showxml()"/>
	        <mx:Button label="保存图片" click="delay()"/>
	        <mx:Text id="proidd" />
			<!--<mx:HSlider minimum="{flowPrentVbox.width/2870}"
				scaleX="{scr.value}"  scaleY="{scr.value}"
			 maximum="2" id="scr" value="1"
				liveDragging="true" snapInterval="0.1" width="459"/>-->
		</mx:HBox>
</mx:Application>
